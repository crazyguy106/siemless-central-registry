title: Suspicious File Renamed via SMB
id: 78e9b5d5-7c07-40a7-a591-3dbbf464c386
status: stable
level: high
description: 'Identifies an incoming SMB connection followed by a suspicious file
  rename operation. This may indicate a remote

  ransomware attack via the SMB protocol.'
author: Elastic (converted by SIEMLess)
date: '2024-05-02'
modified: '2025-02-14'
logsource:
  product: windows
  category: file_event
detection:
  selection:
    _original_eql: "sequence by host.id with maxspan=1s\n [network where host.os.type\
      \ == \"windows\" and\n  event.action == \"connection_accepted\" and destination.port\
      \ == 445 and source.port >= 49152 and process.pid == 4 and\n  source.ip != \"\
      127.0.0.1\" and source.ip != \"::1\" and\n  network.type == \"ipv4\" and not\
      \ endswith(source.address, destination.address)]\n [file where host.os.type\
      \ == \"windows\" and\n  event.action == \"rename\" and process.pid == 4 and\
      \ user.id : (\"S-1-5-21*\", \"S-1-12-*\") and\n  file.extension != null and\
      \ file.Ext.entropy >= 6 and file.path : \"C:\\\\Users\\\\*\" and\n  file.Ext.original.name\
      \ : (\"*.jpg\", \"*.bmp\", \"*.png\", \"*.pdf\", \"*.doc\", \"*.docx\", \"*.xls\"\
      , \"*.xlsx\", \"*.ppt\", \"*.pptx\", \"*.lnk\") and\n  not file.extension :\
      \ (\"jpg\", \"bmp\", \"png\", \"pdf\", \"doc\", \"docx\", \"xls\", \"xlsx\"\
      , \"ppt\", \"pptx\", \"*.lnk\")] with runs=3"
  condition: selection
  _conversion_note: Complex EQL with sequence - requires manual review
tags:
- attack.impact
- attack.lateral_movement
- attack.t1485
- attack.t1021
- attack.t1021.002
- attack.t1490
references:
- https://news.sophos.com/en-us/2023/12/21/akira-again-the-ransomware-that-keeps-on-taking/
