title: Microsoft 365 OAuth Redirect to Device Registration for User Principal
id: fcd2e4be-6ec4-482f-9222-6245367cd738
status: stable
level: high
description: 'Identifies attempts to register a new device in Microsoft Entra ID after
  OAuth authentication with authorization code

  grant. Adversaries may use OAuth phishing techniques to obtain an OAuth authorization
  code, which can then be exchanged

  for access and refresh tokens. This rule detects a sequence of events where a user
  principal authenticates via OAuth,

  followed by a device registration event, indicating potential misuse of the OAuth
  flow to establish persistence or

  access resources.'
author: Elastic (converted by SIEMLess)
date: '2025-04-30'
modified: '2025-09-26'
logsource:
  product: windows
  category: process_creation
detection:
  selection:
    _original_eql: "sequence by related.user with maxspan=30m\n[authentication where\
      \ event.action == \"UserLoggedIn\" and\n o365.audit.ExtendedProperties.RequestType\
      \ == \"OAuth2:Authorize\" and o365.audit.ExtendedProperties.ResultStatusDetail\
      \ == \"Redirect\" and\n o365.audit.UserType: (\"0\", \"2\", \"3\", \"10\")]\
      \ // victim source.ip\n[authentication where event.action == \"UserLoggedIn\"\
      \ and\n o365.audit.ExtendedProperties.RequestType == \"OAuth2:Token\" and o365.audit.ExtendedProperties.ResultStatusDetail\
      \ == \"Success\"] // attacker source.ip to convert oauth code to token\n[web\
      \ where event.dataset == \"o365.audit\" and event.action == \"Add registered\
      \ users to device.\"] // user.name is captured in related.user"
  condition: selection
  _conversion_note: Complex EQL with sequence - requires manual review
tags:
- attack.persistence
- attack.initial_access
- attack.credential_access
- attack.t1528
- attack.t1098
- attack.t1566
- attack.t1098.005
- attack.t1566.002
references:
- https://learn.microsoft.com/en-us/entra/identity-platform/v2-oauth2-auth-code-flow
- https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/
