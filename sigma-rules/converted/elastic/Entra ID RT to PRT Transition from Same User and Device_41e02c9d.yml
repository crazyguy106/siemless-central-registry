title: Entra ID RT to PRT Transition from Same User and Device
id: 40e60816-5122-11f0-9caa-f661ea17fbcd
status: stable
level: medium
description: 'Identifies when a user signs in with a refresh token using the Microsoft
  Authentication Broker (MAB) client, followed by

  a Primary Refresh Token (PRT) sign-in from the same device within 1 hour. This pattern
  may indicate that an attacker has

  successfully registered a device using ROADtx and transitioned from short-term token
  access to long-term persistent

  access via PRTs. Excluding access to the Device Registration Service (DRS) ensures
  the PRT is being used beyond

  registration, often to access Microsoft 365 resources like Outlook or SharePoint.'
author: Elastic (converted by SIEMLess)
date: '2025-06-24'
modified: '2025-09-26'
logsource:
  product: windows
  category: process_creation
detection:
  selection:
    _original_eql: "sequence by azure.signinlogs.properties.user_id, azure.signinlogs.properties.device_detail.device_id\
      \ with maxspan=1h\n  [authentication where\n    event.dataset == \"azure.signinlogs\"\
      \ and\n    azure.signinlogs.category == \"NonInteractiveUserSignInLogs\" and\n\
      \    azure.signinlogs.properties.app_id == \"29d9ed98-a469-4536-ade2-f981bc1d605e\"\
      \ and\n    azure.signinlogs.properties.incoming_token_type == \"refreshToken\"\
      \ and\n    azure.signinlogs.properties.device_detail.trust_type == \"Azure AD\
      \ joined\" and\n    azure.signinlogs.properties.device_detail.device_id != null\
      \ and\n    azure.signinlogs.properties.token_protection_status_details.sign_in_session_status\
      \ == \"unbound\" and\n    azure.signinlogs.properties.user_type == \"Member\"\
      \ and\n    azure.signinlogs.result_signature == \"SUCCESS\"\n  ]\n  [authentication\
      \ where\n    event.dataset == \"azure.signinlogs\" and\n    azure.signinlogs.properties.incoming_token_type\
      \ == \"primaryRefreshToken\" and\n    azure.signinlogs.properties.resource_display_name\
      \ != \"Device Registration Service\" and\n    azure.signinlogs.result_signature\
      \ == \"SUCCESS\"\n  ]"
  condition: selection
  _conversion_note: Complex EQL with sequence - requires manual review
tags:
- attack.persistence
- attack.initial_access
- attack.credential_access
- attack.t1528
- attack.t1098
- attack.t1078.004
- attack.t1078
- attack.t1098.005
references:
- https://www.volexity.com/blog/2025/04/22/phishing-for-codes-russian-threat-actors-target-microsoft-365-oauth-workflows/
- https://dirkjanm.io/abusing-azure-ad-sso-with-the-primary-refresh-token/
