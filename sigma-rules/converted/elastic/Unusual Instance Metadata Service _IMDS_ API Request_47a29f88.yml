title: Unusual Instance Metadata Service (IMDS) API Request
id: ecc0cd54-608e-11ef-ab6d-f661ea17fbce
status: stable
level: medium
description: 'This rule identifies potentially malicious processes attempting to access
  the cloud service provider''s instance metadata

  service (IMDS) API endpoint, which can be used to retrieve sensitive instance-specific
  information such as instance ID,

  public IP address, and even temporary security credentials if role''s are assumed
  by that instance. The rule monitors for

  various tools and scripts like curl, wget, python, and perl that might be used to
  interact with the metadata API.'
author: Elastic (converted by SIEMLess)
date: '2024-08-22'
modified: '2025-09-29'
logsource:
  product: linux
  category: process_creation
detection:
  selection:
    _original_eql: "sequence by host.id, process.parent.entity_id with maxspan=3s\n\
      [\n    process\n    where host.os.type == \"linux\"\n        and event.type\
      \ == \"start\"\n        and event.action == \"exec\"\n        and process.parent.executable\
      \ != null\n\n        // common tooling / suspicious names (keep broad)\n   \
      \     and (\n            process.name : (\n                \"curl\", \"wget\"\
      , \"python*\", \"perl*\", \"php*\", \"ruby*\", \"lua*\", \"telnet\", \"pwsh\"\
      ,\n                \"openssl\", \"nc\", \"ncat\", \"netcat\", \"awk\", \"gawk\"\
      , \"mawk\", \"nawk\", \"socat\", \"node\",\n                \"bash\", \"sh\"\
      \n            )\n            or\n            // suspicious execution locations\
      \ (dropped binaries / temp execution)\n            process.executable : (\n\
      \                \"./*\", \"/tmp/*\", \"/var/tmp/*\", \"/var/www/*\", \"/dev/shm/*\"\
      , \"/etc/init.d/*\", \"/etc/rc*.d/*\",\n                \"/etc/cron*\", \"/etc/update-motd.d/*\"\
      , \"/boot/*\", \"/srv/*\", \"/run/*\", \"/etc/rc.local\"\n            )\n  \
      \          or\n            // threat-relevant IMDS / metadata endpoints (inclusion\
      \ list)\n            process.command_line : (\n                \"*169.254.169.254/latest/api/token*\"\
      ,\n                \"*169.254.169.254/latest/meta-data/iam/security-credentials*\"\
      ,\n                \"*169.254.169.254/latest/meta-data/local-ipv4*\",\n    \
      \            \"*169.254.169.254/latest/meta-data/local-hostname*\",\n      \
      \          \"*169.254.169.254/latest/meta-data/public-ipv4*\",\n           \
      \     \"*169.254.169.254/latest/user-data*\",\n                \"*169.254.169.254/latest/dynamic/instance-identity/document*\"\
      ,\n                \"*169.254.169.254/latest/meta-data/instance-id*\",\n   \
      \             \"*169.254.169.254/latest/meta-data/public-keys*\",\n        \
      \        \"*computeMetadata/v1/instance/service-accounts/*/token*\",\n     \
      \           \"*/metadata/identity/oauth2/token*\",\n                \"*169.254.169.254/opc/v*/instance*\"\
      ,\n                \"*169.254.169.254/opc/v*/vnics*\"\n            )\n     \
      \   )\n\n        // global working-dir / executable / parent exclusions for\
      \ known benign agents\n        and not process.working_directory : (\n     \
      \       \"/opt/rapid7*\",\n            \"/opt/nessus*\",\n            \"/snap/amazon-ssm-agent*\"\
      ,\n            \"/var/snap/amazon-ssm-agent/*\",\n            \"/var/log/amazon/ssm/*\"\
      ,\n            \"/srv/snp/docker/overlay2*\",\n            \"/opt/nessus_agent/var/nessus/*\"\
      \n        )\n\n        and not process.executable : (\n            \"/opt/rumble/bin/rumble-agent*\"\
      ,\n            \"/opt/aws/inspector/bin/inspectorssmplugin\",\n            \"\
      /snap/oracle-cloud-agent/*\",\n            \"/lusr/libexec/oracle-cloud-agent/*\"\
      \n        )\n\n        and not process.parent.executable : (\n            \"\
      /usr/bin/setup-policy-routes\",\n            \"/usr/share/ec2-instance-connect/*\"\
      ,\n            \"/var/lib/amazon/ssm/*\",\n            \"/etc/update-motd.d/30-banner\"\
      ,\n            \"/usr/sbin/dhclient-script\",\n            \"/usr/local/bin/uwsgi\"\
      ,\n            \"/usr/lib/skylight/al-extras\",\n            \"/usr/bin/cloud-init\"\
      ,\n            \"/usr/sbin/waagent\",\n            \"/usr/bin/google_osconfig_agent\"\
      ,\n            \"/usr/bin/docker\",\n            \"/usr/bin/containerd-shim\"\
      ,\n            \"/usr/bin/runc\"\n        )\n\n        and not process.entry_leader.executable\
      \ : (\n            \"/usr/local/qualys/cloud-agent/bin/qualys-cloud-agent\"\
      ,\n            \"/opt/Elastic/Agent/data/elastic-agent-*/elastic-agent\",\n\
      \            \"/opt/nessus_agent/sbin/nessus-service\"\n        )\n\n      \
      \  // carve-out: safe /usr/bin/curl usage (suppress noisy, legitimate agent\
      \ patterns)\n        and not (\n            process.executable == \"/usr/bin/curl\"\
      \n            and (\n                // AWS IMDSv2 token PUT that includes ttl\
      \ header\n                (process.command_line : \"*-X PUT*169.254.169.254/latest/api/token*\"\
      \ and process.command_line : \"*X-aws-ec2-metadata-token-ttl-seconds*\")\n \
      \               or\n                // Any IMDSv2 GET that includes token header\
      \ for any /latest/* path\n                process.command_line : \"*-H X-aws-ec2-metadata-token:*169.254.169.254/latest/*\"\
      \n                or\n                // Common amazon tooling UA\n        \
      \        process.command_line : \"*-A amazon-ec2-net-utils/*\"\n           \
      \     or\n                // Azure metadata legitimate header\n            \
      \    process.command_line : \"*-H Metadata:true*169.254.169.254/metadata/*\"\
      \n                or\n                // Oracle IMDS legitimate header\n   \
      \             process.command_line : \"*-H Authorization:*Oracle*169.254.169.254/opc/*\"\
      \n            )\n        )\n]\n[\n    network where host.os.type == \"linux\"\
      \n        and event.action == \"connection_attempted\"\n        and destination.ip\
      \ == \"169.254.169.254\"\n]"
  condition: selection
  _conversion_note: Complex EQL with sequence - requires manual review
tags:
- attack.discovery
- attack.credential_access
- attack.t1552
- attack.t1552.005
- attack.t1580
references:
- https://hackingthe.cloud/aws/general-knowledge/intro_metadata_service/
- https://www.wiz.io/blog/imds-anomaly-hunting-zero-day
