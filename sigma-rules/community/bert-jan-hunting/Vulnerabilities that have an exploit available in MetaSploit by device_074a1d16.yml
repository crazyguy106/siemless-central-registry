title: Vulnerabilities that have an exploit available in MetaSploit by device
id: 0e8df1b2-b9c6-4d6d-8b7b-8e27afe3e77f
status: experimental
level: medium
description: |
  KQL detection rule: Vulnerabilities that have an exploit available in MetaSploit by device
author: Bert-JanP
logsource:
  product: microsoft_security
  service: kql
detection:
  _kql_query: |
    let MetaSploitExploitsWithAssignedCVE = externaldata(cveid: string)[@"https://feeds.ecrimelabs.net/data/metasploit-cve"] with (format="txt", ignoreFirstRecord=True);
    DeviceTvmSoftwareVulnerabilities
    | where CveId in~ (MetaSploitExploitsWithAssignedCVE)
    | summarize
     TotalVulnerabilities = dcount(CveId),
     Vulnerabilities = make_set(CveId)
     by DeviceName
    | sort by TotalVulnerabilities
  condition: _kql_query
references:
  - https://github.com/Bert-JanP/Hunting-Queries-Detection-Rules
