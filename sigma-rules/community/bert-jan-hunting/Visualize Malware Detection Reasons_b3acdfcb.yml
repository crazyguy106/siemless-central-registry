title: Visualize Malware Detection Reasons
id: f1d010e1-84a8-4a9f-b824-8bb5ba6ffd57
status: experimental
level: medium
description: |
  This query visualizes the malware detection reasons in a piechart. This is based on the EmailPostDeliveryEvents table. This table in the advanced hunting schema contains information about post-delivery actions taken on email messages processed by Microsoft 365. Based on this information the differnt detection reasons are visualized.
author: Bert-JanP
logsource:
  product: office_365
  service: kql
detection:
  _kql_query: |
    EmailPostDeliveryEvents
    | where ThreatTypes == "Malware"
    | extend DetectionMethod = tostring(extract(@'Malware":\["(.*?)"]', 1, DetectionMethods))
    | summarize TotalEvents = count() by DetectionMethod
    | render piechart with(title="Malware Detection Reason Overview")
  condition: _kql_query
references:
  - https://github.com/Bert-JanP/Hunting-Queries-Detection-Rules
