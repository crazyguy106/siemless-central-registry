title: Windows Cached Domain Credentials Reg Query
id: bcbf6df5-3284-56e6-abd1-6fae7640c117
status: stable
level: medium
description: |
  The following analytic identifies a process command line querying the CachedLogonsCount registry value in the Winlogon registry. This detection leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line executions and registry queries. Monitoring this activity is significant as it can indicate the use of post-exploitation tools like Winpeas, which gather information about login caching settings. If confirmed malicious, this activity could help attackers understand
author: Teoderick Contreras, Splunk
logsource:
  product: windows
  category: authentication
detection:
  selection:
    process:
      - '* query *'
      - '*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon*'
      - '*CACHEDLOGONSCOUNT*'
  condition: selection
tags:
  - attack.t1003.005
references:
  - https://www.microsoft.com/en-us/security/blog/2022/10/14/new-prestige-ransomware-impacts-organizations-in-ukraine-and-poland/
  - https://learn.microsoft.com/de-de/troubleshoot/windows-server/user-profiles-and-logon/cached-domain-logon-information
  - https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS
custom_attributes:
  original_rule_id: 40ccb8e0-1785-466e-901e-6a8b75c04ecd
  source_format: splunk_spl