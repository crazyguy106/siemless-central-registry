title: Get-DomainTrust with PowerShell Script Block
id: 5c0244a2-e48f-5dab-971d-6fd96a71ac16
status: stable
level: high
description: |
  The following analytic detects the execution of the Get-DomainTrust command from PowerView using PowerShell Script Block Logging (EventCode=4104). This method captures the full command sent to PowerShell, allowing for detailed inspection. Identifying this activity is significant because it may indicate an attempt to gather domain trust information, which is often a precursor to lateral movement or privilege escalation. If confirmed malicious, this activity could enable an attacker to map trust r
author: Michael Haag, Splunk
logsource:
  product: windows
detection:
  selection:
    scriptblocktext: '*get-domaintrust*'
    eventcode: 4104
  condition: selection
tags:
  - attack.t1482
references:
  - https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/
  - https://help.splunk.com/en/security-offerings/splunk-user-behavior-analytics/get-data-in/5.4.1/add-other-data-to-splunk-uba/configure-powershell-logging-to-see-powershell-anomalies-in-splunk-uba.
  - https://blog.palantir.com/tampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63
  - https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/59c1814829f18782e24f1fe2/1505853768977/Windows+PowerShell+Logging+Cheat+Sheet+ver+Sept+2017+v2.1.pdf
  - https://www.crowdstrike.com/blog/investigating-powershell-command-and-script-logging/
custom_attributes:
  original_rule_id: 89275e7e-0548-11ec-bf75-acde48001122
  source_format: splunk_spl