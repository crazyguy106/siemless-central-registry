title: Exchange PowerShell Module Usage
id: 60d0420e-e4c6-549b-8686-1e8b699f6e33
status: stable
level: high
description: |
  The following analytic detects the usage of specific Exchange PowerShell modules, such as New-MailboxExportRequest, New-ManagementRoleAssignment, New-MailboxSearch, and Get-Recipient. It leverages PowerShell Script Block Logging (EventCode 4104) to identify these commands. This activity is significant because these modules can be exploited by adversaries who have gained access via ProxyShell or ProxyNotShell vulnerabilities. If confirmed malicious, attackers could export mailbox contents, assign
author: Michael Haag, Splunk
logsource:
  product: windows
detection:
  selection:
    eventcode: 4104
    scriptblocktext:
      - '*New-MailboxExportRequest*'
      - '*New-ManagementRoleAssignment*'
      - '*New-MailboxSearch*'
      - '*Get-Recipient*'
      - Search-Mailbox
  condition: selection
tags:
  - attack.t1059.001
references:
  - https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps
  - https://docs.microsoft.com/en-us/powershell/module/exchange/new-managementroleassignment?view=exchange-ps
  - https://blog.orange.tw/2021/08/proxyshell-a-new-attack-surface-on-ms-exchange-part-3.html
  - https://www.zerodayinitiative.com/blog/2021/8/17/from-pwn2own-2021-a-new-attack-surface-on-microsoft-exchange-proxyshell
  - https://thedfirreport.com/2021/11/15/exchange-exploit-leads-to-domain-wide-ransomware/
custom_attributes:
  original_rule_id: 2d10095e-05ae-11ec-8fdf-acde48001122
  source_format: splunk_spl