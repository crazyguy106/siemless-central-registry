title: Powershell Enable SMB1Protocol Feature
id: 41c4fc3e-bb66-5016-851e-b470405cf246
status: stable
level: high
description: |
  The following analytic detects the enabling of the SMB1 protocol via `powershell.exe`. It leverages PowerShell script block logging (EventCode 4104) to identify the execution of the `Enable-WindowsOptionalFeature` cmdlet with the `SMB1Protocol` parameter. This activity is significant because enabling SMB1 can facilitate lateral movement and file encryption by ransomware, such as RedDot. If confirmed malicious, this action could allow an attacker to propagate through the network, encrypt files, a
author: Teoderick Contreras, Splunk
logsource:
  product: windows
detection:
  selection:
    scriptblocktext:
      - '*Enable-WindowsOptionalFeature*'
      - '*SMB1Protocol*'
    eventcode: 4104
  condition: selection
tags:
  - attack.t1027.005
references:
  - https://app.any.run/tasks/c0f98850-af65-4352-9746-fbebadee4f05/
  - https://www.splunk.com/en_us/blog/security/hunting-for-malicious-powershell-using-script-block-logging.html
custom_attributes:
  original_rule_id: afed80b2-d34b-11eb-a952-acde48001122
  source_format: splunk_spl