title: Mailsniper Invoke functions
id: ff1cb434-a3c6-53fd-8350-7e80753796ce
status: stable
level: high
description: |
  The following analytic detects the execution of known MailSniper PowerShell functions on a machine. It leverages PowerShell logs (EventCode 4104) to identify specific script block text associated with MailSniper activities. This behavior is significant as MailSniper is often used by attackers to harvest sensitive emails from compromised Exchange servers. If confirmed malicious, this activity could lead to unauthorized access to sensitive email data, credential theft, and further compromise of th
author: Teoderick Contreras, Splunk
logsource:
  product: windows
detection:
  selection:
    eventcode: 4104
    scriptblocktext:
      - '*Invoke-GlobalO365MailSearch*'
      - '*Invoke-GlobalMailSearch*'
      - '*Invoke-SelfSearch*'
      - '*Invoke-PasswordSprayOWA*'
      - '*Invoke-PasswordSprayEWS*'
      - '*Invoke-DomainHarvestOWA*'
      - '*Invoke-UsernameHarvestOWA*'
      - '*Invoke-OpenInboxFinder*'
      - '*Invoke-InjectGEventAPI*'
      - '*Invoke-InjectGEvent*'
      - '*Invoke-SearchGmail*'
      - '*Invoke-MonitorCredSniper*'
      - '*Invoke-AddGmailRule*'
      - '*Invoke-PasswordSprayEAS*'
      - '*Invoke-UsernameHarvestEAS*'
  condition: selection
tags:
  - attack.t1114.001
references:
  - https://www.blackhillsinfosec.com/introducing-mailsniper-a-tool-for-searching-every-users-email-for-sensitive-data/
custom_attributes:
  original_rule_id: a36972c8-b894-11eb-9f78-acde48001122
  source_format: splunk_spl