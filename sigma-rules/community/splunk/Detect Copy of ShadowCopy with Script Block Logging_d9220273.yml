title: Detect Copy of ShadowCopy with Script Block Logging
id: 140751bb-f5ab-5bc5-bf9e-05e739d1b411
status: stable
level: high
description: |
  The following analytic detects the use of PowerShell commands to copy the SAM, SYSTEM, or SECURITY hives, which are critical for credential theft. It leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze the full command executed. This activity is significant as it indicates an attempt to exfiltrate sensitive registry hives for offline password cracking. If confirmed malicious, this could lead to unauthorized access to credentials, enabling further compromise of the s
author: Michael Haag, Splunk
logsource:
  product: windows
detection:
  selection:
    eventcode: 4104
    scriptblocktext:
      - '*System32\\config\\SAM*'
      - '*System32\\config\\SYSTEM*'
      - '*System32\\config\\SECURITY*'
  condition: selection
tags:
  - attack.t1003.002
references:
  - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
  - https://github.com/GossiTheDog/HiveNightmare
  - https://github.com/JumpsecLabs/Guidance-Advice/tree/main/SAM_Permissions
custom_attributes:
  original_rule_id: 9251299c-ea5b-11eb-a8de-acde48001122
  source_format: splunk_spl