title: Powershell Get LocalGroup Discovery with Script Block Logging
id: b79853c3-c1c3-51a7-ade2-e51e430d02c8
status: stable
level: low
description: |
  The following analytic detects the execution of the PowerShell cmdlet `get-localgroup` using PowerShell Script Block Logging (EventCode=4104). This method captures the full command sent to PowerShell, providing detailed visibility into script execution. Monitoring this activity is significant as it can indicate an attempt to enumerate local groups, which may be a precursor to privilege escalation or lateral movement. If confirmed malicious, an attacker could gain insights into group memberships,
author: Michael Haag, Splunk
logsource:
  product: windows
detection:
  selection:
    scriptblocktext: '*get-localgroup*'
    eventcode: 4104
  condition: selection
tags:
  - attack.t1069.001
references:
  - https://www.splunk.com/en_us/blog/security/powershell-detections-threat-research-release-august-2021.html
  - https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1069.001/T1069.001.md
  - https://help.splunk.com/en/security-offerings/splunk-user-behavior-analytics/get-data-in/5.4.1/add-other-data-to-splunk-uba/configure-powershell-logging-to-see-powershell-anomalies-in-splunk-uba
  - https://blog.palantir.com/tampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63
  - https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/59c1814829f18782e24f1fe2/1505853768977/Windows+PowerShell+Logging+Cheat+Sheet+ver+Sept+2017+v2.1.pdf
custom_attributes:
  original_rule_id: d7c6ad22-155c-11ec-bb64-acde48001122
  source_format: splunk_spl